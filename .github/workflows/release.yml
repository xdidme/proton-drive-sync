name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    if: github.event_name == 'release'
    strategy:
      matrix:
        include:
          - os: macos-15
            target: darwin-arm64
          - os: macos-15-intel
            target: darwin-x64
          - os: ubuntu-latest
            target: linux-x64
          - os: ubuntu-24.04-arm
            target: linux-arm64
          - os: windows-latest
            target: windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        run: bun build --compile --minify --target=bun-${{ matrix.target }} ./src/index.ts --outfile ./proton-drive-sync

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        run: bun build --compile --minify --target=bun-${{ matrix.target }} ./src/index.ts --outfile ./proton-drive-sync.exe

      - name: Create tarball (Unix)
        if: runner.os != 'Windows'
        run: tar -czvf proton-drive-sync-${{ matrix.target }}.tar.gz proton-drive-sync

      - name: Create zip (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Compress-Archive -Path proton-drive-sync.exe -DestinationPath proton-drive-sync-${{ matrix.target }}.zip

      - name: Upload to release (Unix)
        if: runner.os != 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: proton-drive-sync-${{ matrix.target }}.tar.gz

      - name: Upload to release (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: proton-drive-sync-${{ matrix.target }}.zip

  package-x64:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version and package name
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "package_name=proton-drive-sync-prerelease" >> $GITHUB_OUTPUT
          else
            echo "package_name=proton-drive-sync" >> $GITHUB_OUTPUT
          fi

      - name: Download Linux x64 artifact
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p artifacts
          gh release download "v${VERSION}" -p "proton-drive-sync-linux-x64.tar.gz" -D artifacts/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Extract binary
        run: |
          mkdir -p binaries
          tar -xzf artifacts/proton-drive-sync-linux-x64.tar.gz -C binaries/

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev rpm dpkg-sig

      - name: Setup GPG
        run: ./packaging/scripts/setup-gpg.sh
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Build and sign .deb package
        run: ./packaging/scripts/build-deb.sh
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: amd64
          BINARY_PATH: binaries/proton-drive-sync
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PACKAGE_NAME: ${{ steps.version.outputs.package_name }}

      - name: Build and sign .rpm package
        run: ./packaging/scripts/build-rpm.sh
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: x86_64
          BINARY_PATH: binaries/proton-drive-sync
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PACKAGE_NAME: ${{ steps.version.outputs.package_name }}

      - name: Upload packages to release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          gh release upload "v${VERSION}" \
            ${{ steps.version.outputs.package_name }}_${VERSION}_amd64.deb \
            ${{ steps.version.outputs.package_name }}-*.x86_64.rpm
        env:
          GH_TOKEN: ${{ github.token }}

  package-arm64:
    needs: build
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version and package name
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "package_name=proton-drive-sync-prerelease" >> $GITHUB_OUTPUT
          else
            echo "package_name=proton-drive-sync" >> $GITHUB_OUTPUT
          fi

      - name: Download Linux arm64 artifact
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p artifacts
          gh release download "v${VERSION}" -p "proton-drive-sync-linux-arm64.tar.gz" -D artifacts/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Extract binary
        run: |
          mkdir -p binaries
          tar -xzf artifacts/proton-drive-sync-linux-arm64.tar.gz -C binaries/

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev rpm dpkg-sig

      - name: Setup GPG
        run: ./packaging/scripts/setup-gpg.sh
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Build and sign .deb package
        run: ./packaging/scripts/build-deb.sh
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: arm64
          BINARY_PATH: binaries/proton-drive-sync
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PACKAGE_NAME: ${{ steps.version.outputs.package_name }}

      - name: Build and sign .rpm package
        run: ./packaging/scripts/build-rpm.sh
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: aarch64
          BINARY_PATH: binaries/proton-drive-sync
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PACKAGE_NAME: ${{ steps.version.outputs.package_name }}

      - name: Upload packages to release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          gh release upload "v${VERSION}" \
            ${{ steps.version.outputs.package_name }}_${VERSION}_arm64.deb \
            ${{ steps.version.outputs.package_name }}-*.aarch64.rpm
        env:
          GH_TOKEN: ${{ github.token }}

  upload-gemfury:
    needs: [package-x64, package-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Download packages from release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p packages
          gh release download "v${VERSION}" -p "*.deb" -p "*.rpm" -D packages/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload to Gemfury
        run: ./packaging/scripts/upload-gemfury.sh
        env:
          GEMFURY_TOKEN: ${{ secrets.GEMFURY_TOKEN }}
          PACKAGES_DIR: packages

  update-homebrew:
    needs: [package-x64, package-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TAP_UPDATE_TOKEN }}
          repository: DamianB-BitFlipper/homebrew-tap
          event-type: update-formula
          client-payload: '{"version": "${{ github.event.release.tag_name }}", "prerelease": ${{ github.event.release.prerelease }}}'
