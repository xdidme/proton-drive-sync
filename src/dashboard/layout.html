<!doctype html>
<html lang="en" class="h-full bg-gray-900 text-gray-100 antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{TITLE}}</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script src="https://unpkg.com/idiomorph@0.3.0/dist/idiomorph-ext.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1f2937;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }
      /* Hide tab labels when viewport is too narrow */
      .tab-label {
        display: none;
      }
      @media (min-width: 1250px) {
        .tab-label {
          display: inline;
        }
      }
      /* Hide GitHub text before title */
      .socials-text {
        display: none;
      }
      @media (min-width: 700px) {
        .socials-text {
          display: inline;
        }
      }
      /* Hide title when narrower */
      .header-title {
        display: none;
      }
      @media (min-width: 1000px) {
        .header-title {
          display: block;
        }
      }
      /* Hide auth badge when very narrow */
      .auth-badge {
        display: none;
      }
      @media (min-width: 900px) {
        .auth-badge {
          display: block;
        }
      }
      /* Hide connected badge at the very end */
      .connected-badge {
        display: none;
      }
      @media (min-width: 600px) {
        .connected-badge {
          display: flex;
        }
      }
      /* Hide GitHub badge first (least priority in header) */
      .github-badge-header {
        display: none;
      }
      @media (min-width: 1400px) {
        .github-badge-header {
          display: flex;
        }
      }
      /* Hide X badge second */
      .x-badge-header {
        display: none;
      }
      @media (min-width: 1300px) {
        .x-badge-header {
          display: flex;
        }
      }
      /* Coffee badge always visible (when badges are shown) */
      /* GitHub badge star hover effect */
      .github-badge:hover [data-lucide='star'] {
        color: #facc15; /* yellow-400 */
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              proton: {
                DEFAULT: '#6d4aff',
                dark: '#5a3dd6',
                light: '#886bff',
              },
            },
            fontFamily: {
              mono: [
                'SF Mono',
                'Menlo',
                'Monaco',
                'Consolas',
                'Liberation Mono',
                'Courier New',
                'monospace',
              ],
            },
          },
        },
      };
    </script>
  </head>
  <body class="h-full flex flex-col" hx-ext="sse,morph" sse-connect="/api/events">
    <!-- Dry-Run Warning Banner -->
    <div
      id="dry-run-banner"
      hx-get="/api/fragments/dry-run-banner"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></div>

    <!-- Hidden heartbeat listener to trigger pulse animation -->
    <div
      id="heartbeat-listener"
      class="hidden"
      sse-swap="heartbeat"
      hx-on::after-swap="document.body.dispatchEvent(new CustomEvent('heartbeat-received'))"
    ></div>

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 shadow-sm sticky top-0 z-50">
      <div class="h-16 flex items-center justify-between gap-4 pl-4 pr-4">
        <div class="flex items-center gap-6 min-w-0">
          <a href="/" class="flex items-center gap-3 shrink-0">
            <img
              src="/assets/icon.svg"
              alt="Proton Drive Sync"
              class="w-8 h-8 rounded-lg shadow-lg shadow-proton/20"
            />
            <!-- Title: second to collapse (below 700px) -->
            <h1 class="header-title text-xl font-bold tracking-tight text-white whitespace-nowrap">
              Proton Drive Sync!
            </h1>
          </a>

          <!-- Tab Navigation -->
          <nav class="flex items-center gap-1">
            <a
              href="/"
              class="{{HIDE_HOME_TAB}} flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium transition-colors whitespace-nowrap {{HOME_TAB_CLASS}}"
            >
              <i data-lucide="house" class="w-4 h-4 shrink-0"></i>
              <!-- Tab labels: first to collapse (below 850px) -->
              <span class="tab-label">Home</span>
            </a>
            <a
              href="/controls"
              class="flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium transition-colors whitespace-nowrap {{CONTROLS_TAB_CLASS}}"
            >
              <i data-lucide="sliders-horizontal" class="w-4 h-4 shrink-0"></i>
              <!-- Tab labels: first to collapse (below 850px) -->
              <span class="tab-label">Controls</span>
            </a>
            <a
              href="/about"
              class="flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium transition-colors whitespace-nowrap {{ABOUT_TAB_CLASS}}"
            >
              <i data-lucide="compass" class="w-4 h-4 shrink-0"></i>
              <!-- Tab labels: first to collapse (below 850px) -->
              <span class="tab-label">About</span>
            </a>
          </nav>
        </div>

        <div class="flex items-center gap-4 shrink-0">
          <!-- X Follow, GitHub Stars Badge and Buy Me a Coffee (hidden on about page) -->
          <div class="flex items-center gap-2 {{HIDE_BADGES}}">
            <!-- X (Twitter) Follow Badge -->
            <a
              href="https://x.com/TheBitFlipper"
              target="_blank"
              class="x-badge-header h-9 flex items-center gap-2 px-3 bg-gray-900 border border-gray-600 rounded-full hover:border-gray-500 transition-colors"
            >
              <img src="/assets/x-logo.svg" alt="X" class="w-4 h-4" />
              <span class="socials-text text-gray-300 text-sm font-medium">Follow</span>
            </a>

            <!-- GitHub Stars Badge -->
            <a
              href="https://github.com/DamianB-BitFlipper/proton-drive-sync"
              target="_blank"
              class="github-badge github-badge-header h-9 flex items-center gap-2 px-3 bg-gray-900 border border-gray-600 rounded-full hover:border-gray-500 transition-colors"
            >
              <img src="/assets/github.svg" alt="GitHub" class="w-4 h-4" />
              <span class="socials-text text-gray-300 text-sm font-medium">GitHub</span>
              <i data-lucide="star" class="w-4 h-4 text-white transition-colors fill-current"></i>
              <img
                src="https://img.shields.io/github/stars/DamianB-BitFlipper/proton-drive-sync?style=flat&label=&color=1f2937"
                alt="Stars"
                class="h-5"
              />
            </a>

            <!-- Buy Me a Coffee -->
            <a href="https://www.buymeacoffee.com/thebitflipper" target="_blank">
              <img
                src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png"
                alt="Buy Me A Coffee"
                class="h-9 w-auto"
              />
            </a>
          </div>

          <!-- Auth Status: third to collapse (below 550px) -->
          <div
            id="auth-status"
            class="auth-badge"
            hx-get="/api/fragments/auth-status"
            hx-trigger="load"
            hx-swap="morph:innerHTML"
            sse-swap="auth"
          ></div>

          <!-- Syncing Status: last to collapse (below 500px) -->
          <div
            id="syncing-status"
            class="connected-badge"
            hx-get="/api/fragments/syncing-status"
            hx-trigger="load"
            hx-swap="morph:innerHTML"
            sse-swap="syncing"
          ></div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto custom-scrollbar p-8">{{CONTENT}}</main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2"></div>

    <script>
      // Toast notification system
      function showToast(message, type = 'success', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');

        const colors = {
          success: 'bg-green-600 border-green-500',
          error: 'bg-red-600 border-red-500',
          info: 'bg-blue-600 border-blue-500',
        };

        const icons = {
          success:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />',
          error:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />',
          info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
        };

        toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg text-white text-sm font-medium transform translate-x-full opacity-0 transition-all duration-300 ${colors[type] || colors.info}`;
        toast.innerHTML = `
          <svg class="w-5 h-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            ${icons[type] || icons.info}
          </svg>
          <span>${message}</span>
        `;

        container.appendChild(toast);

        // Trigger animation
        requestAnimationFrame(() => {
          toast.classList.remove('translate-x-full', 'opacity-0');
        });

        // Auto dismiss
        setTimeout(() => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Store SSE EventSource reference for cleanup
      let sseSource = null;

      // Capture the EventSource when connection opens
      document.body.addEventListener('htmx:sseOpen', (e) => {
        sseSource = e.detail.source;
      });

      // Close SSE before navigating to prevent connection pile-up
      document.querySelectorAll('a[href^="/"]').forEach((link) => {
        link.addEventListener('click', () => {
          if (sseSource) {
            sseSource.close();
            sseSource = null;
          }
        });
      });

      // Also close on page unload (e.g., refresh, external navigation)
      window.addEventListener('beforeunload', () => {
        if (sseSource) {
          sseSource.close();
          sseSource = null;
        }
      });

      // Pulse the heartbeat dot on each heartbeat event
      document.body.addEventListener('heartbeat-received', () => {
        const ping = document.getElementById('heartbeat-ping');
        if (ping) {
          ping.classList.remove('opacity-0');
          ping.classList.add('animate-ping', 'opacity-75');
          setTimeout(() => {
            ping.classList.remove('animate-ping', 'opacity-75');
            ping.classList.add('opacity-0');
          }, 500);
        }
      });

      // Initialize Lucide icons
      lucide.createIcons();

      // Reinitialize Lucide icons after HTMX swaps in new content
      document.body.addEventListener('htmx:afterSwap', () => {
        lucide.createIcons();
      });
    </script>
    {{PAGE_SCRIPTS}}
  </body>
</html>
